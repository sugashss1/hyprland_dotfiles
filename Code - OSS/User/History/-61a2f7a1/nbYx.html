{% extends "base.html" %}

{% block title %}Kanban Board{% endblock %}

{% block content %}

<div class="container">
  <h1>Kanban Board</h1>
  <p>Drag and drop tasks to update their status</p>

  <div class="kanban">
    <div class="column">
      <h3>TODO</h3>
      <div id="todo" class="task-column"></div>
    </div>

    <div class="column">
      <h3>IN PROGRESS</h3>
      <div id="in_progress" class="task-column"></div>
    </div>

    <div class="column">
      <h3>DONE</h3>
      <div id="done" class="task-column"></div>
    </div>
  </div>
</div>

<script>
async function loadBoard() {
  const [projects, tasks] = await Promise.all([
    fetch("/api/projects").then(res => res.json()),
    fetch("/api/tasks").then(res => res.json())
  ]);

  const grouped = groupTasksByProject(projects, tasks);
  renderProjects(grouped);
}

function groupTasksByProject(projects, tasks) {
  const map = {};

  projects.forEach(project => {
    map[project.project_name] = {
      project: project,
      tasks: []
    };
  });

  tasks.forEach(task => {
    const key = task.project_name || "Unassigned";

    if (!map[key]) {
      map[key] = {
        project: { project_name: key },
        tasks: []
      };
    }

    map[key].tasks.push(task);
  });

  return map;
}

function renderProjects(projectMap) {
  const container = document.getElementById("kanban");
  container.innerHTML = "";

  Object.values(projectMap).forEach(group => {
    const section = document.createElement("section");

    const title = document.createElement("h2");
    title.textContent = group.project.project_name;
    section.appendChild(title);

    const board = document.createElement("div");

    ["TODO", "IN_PROGRESS", "DONE"].forEach(status => {
      const col = document.createElement("div");
      const heading = document.createElement("h3");
      heading.textContent = status.replace("_", " ");

      const column = document.createElement("div");
      column.dataset.status = status;

      column.ondragover = e => e.preventDefault();
      column.ondrop = async e => {
        const id = e.dataTransfer.getData("id");
        await updateStatus(id, status);
        loadBoard();
      };

      col.appendChild(heading);
      col.appendChild(column);
      board.appendChild(col);
    });

    group.tasks.forEach(task => {
      const el = document.createElement("div");
      el.draggable = true;

      el.ondragstart = e => {
        e.dataTransfer.setData("id", task.id);
      };

      el.innerHTML = `
        <strong>${task.title}</strong><br>
        <small>${task.assigned_to}</small>
      `;

      const target = board.querySelector(
        `[data-status="${task.status || "TODO"}"]`
      );
      if (target) {
        target.appendChild(el);
      }
    });

    section.appendChild(board);
    container.appendChild(section);
  });
}

async function updateStatus(id, status) {
  await fetch(`/api/tasks/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status })
  });
}

loadBoard();

</script>

{% endblock %}
