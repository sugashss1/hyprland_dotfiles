{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-row">

  <!-- LEFT: Welcome Card -->
  <div class="card dashboard-card">
    <h2>Welcome</h2>
    <p><strong>Name:</strong> {{ name }}</p>
    <p><strong>Email:</strong> {{ email }}</p>
    <p><strong>Role:</strong> {{ role }}</p>
    <p><strong>Tenant:</strong> {{ tenant_id }}</p>

    {% if role != "user" %}
      <h4>Admin Actions</h4>
      <a href="/admin/users/create">âž• Create User</a>
    {% endif %}
  </div>

  <!-- RIGHT: Visualization (separate from card) -->
  <div class="task-visualization standalone-visualization">
    <h4>Task Status Overview</h4>
    <canvas id="taskStatusChart"></canvas>
  </div>

</div>


  <!-- ADD TASK FORM (only for manager) -->
  <div id="taskFormContainer" style="display:none;">
    <h2>Add Task</h2>
    <form id="taskForm">


      <div>
        <label>Project Name</label>
        <select name="project_name" required id="projectSelect">
          <option value="">Loading...</option>
        </select>
      </div>

      <div>
        <label>Title</label>
        <input type="text" name="title" required>
      </div>

      <div>
        <label>Description</label>
        <textarea name="description"></textarea>
      </div>
      <div>
        <label>Assigned To</label>
        <select name="assigned_to" id="assignedSelect" required>
          <option value="">Loading...</option>
        </select>
      </div>


      <div>
        <label>Start Date</label>
        <input type="date" name="start_date" required>
      </div>

      <div>
        <label>Due Date</label>
        <input type="date" name="due_date" required>
      </div>

      <button type="submit">Create Task</button>
    </form>
    <hr>
  </div>
<script>
    const userRole = "{{ session.get('role') }}"; // manager / ceo / employee

/* -------------------------------
   SHOW TASK FORM FOR MANAGER ONLY
-------------------------------- */
if (userRole === "manager") {
  document.getElementById("taskFormContainer").style.display = "block";

  // Load projects into select
  async function loadProjects() {
    const res = await fetch("/api/projects");
    const projects = await res.json();

    const select = document.getElementById("projectSelect");
    select.innerHTML = "";

    projects.forEach(proj => {
      const opt = document.createElement("option");
      opt.value = proj.project_name;
      opt.textContent = proj.project_name;
      select.appendChild(opt);
    });
  }

  loadProjects();

  // Handle task creation
  document.getElementById("taskForm").addEventListener("submit", async e => {
    e.preventDefault();
    const form = e.target;

    const payload = {
      project_name: form.project_name.value,
      title: form.title.value,
      description: form.description.value || "",
      assigned_to: form.assigned_to.value,
      start_date: form.start_date.value,
      due_date: form.due_date.value
    };

    const res = await fetch("/api/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      form.reset();
      loadTasks();
    } else {
      alert("Failed to create task");
    }
  });
}

async function loadAssignedUsers() {
  const res = await fetch("/api/user-by-manager-id");
  const users = await res.json();

  const select = document.getElementById("assignedSelect");
  select.innerHTML = "";

  if (users.length === 0) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No users found";
    select.appendChild(opt);
  } else {
    users.forEach(user => {
      const opt = document.createElement("option");
      opt.value = user.email;   // set value as user's email
      opt.textContent = user.full_name + " (" + user.email + ")";
      select.appendChild(opt);
    });
  }
}

// Call this function when the form loads
loadAssignedUsers();


</script>

<!-- CREATE PROJECT FORM -->
<div id="projectFormContainer" style="display:none;">
  <h2>Create Project</h2>
  <form id="projectForm">

    <div>
      <label>Project Name</label>
      <input type="text" name="project_name" required>
    </div>

    <div>
      <label>Description</label>
      <textarea name="description"></textarea>
    </div>

    <div>
      <label>Start Date</label>
      <input type="date" name="start_date" required>
    </div>

    <div>
      <label>Due Date</label>
      <input type="date" name="due_date" required>
    </div>

    <!-- Assigned to (only for CEO) -->
    <div id="managerSelectContainer" style="display:none;">
      <label>Assign Manager</label>
      <select name="manager_id" id="managerSelect">
        <option value="">Loading...</option>
      </select>
    </div>

    <button type="submit">Create Project</button>
  </form>
  <hr>
</div>

<script>

if (userRole === "manager" || userRole === "ceo") {
  document.getElementById("projectFormContainer").style.display = "block";

  // CEO: show manager select and populate
  if (userRole === "ceo") {
    document.getElementById("managerSelectContainer").style.display = "block";

    async function loadManagers() {
      const res = await fetch("/api/all-user");
      const users = await res.json();

      const select = document.getElementById("managerSelect");
      select.innerHTML = "";

      const managers = users.filter(u => u.role === "manager");
      if (managers.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No managers found";
        select.appendChild(opt);
      } else {
        managers.forEach(user => {
          const opt = document.createElement("option");
          opt.value = user.tenant_id || user.id;
          opt.textContent = `${user.full_name} (${user.email})`;
          select.appendChild(opt);
        });
      }
    }

    loadManagers();
  }

  // Handle project creation
  document.getElementById("projectForm").addEventListener("submit", async e => {
    e.preventDefault();
    const form = e.target;

    const payload = {
      project_name: form.project_name.value,
      description: form.description.value || "",
      start_date: form.start_date.value,
      due_date: form.due_date.value
    };

    if (userRole === "ceo") {
      payload.manager_id = form.manager_id.value;
    }

    const res = await fetch("/api/projects", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      form.reset();
      loadProjects();  // refresh project list
      alert("Project created successfully!");
    } else {
      alert("Failed to create project");
    }
  });
}
</script>

<!-- Include Chart.js (CDN): -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function renderTaskStatusChart() {
  const res = await fetch("/api/tasks");
  const tasks = await res.json();

  // Count tasks by status
  const statusCounts = { "TODO": 0, "IN_PROGRESS": 0, "DONE": 0 };
  tasks.forEach(task => {
    const status = (task.status || "TODO").toUpperCase();
    if (statusCounts[status] !== undefined) {
      statusCounts[status]++;
    }
  });

  const ctx = document.getElementById('taskStatusChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut', // can be 'bar' or 'pie'
    data: {
      labels: ["TODO", "IN PROGRESS", "DONE"],
      datasets: [{
        data: [statusCounts["TODO"], statusCounts["IN PROGRESS"], statusCounts["DONE"]],
        backgroundColor: ["#f39c12", "#3498db", "#2ecc71"]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}

// Render chart on page load
renderTaskStatusChart();
</script>


{% endblock %}
