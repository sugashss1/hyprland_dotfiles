<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}App{% endblock %}</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* Chatbot button bottom-left */
    #chatbotButton {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    /* Chat panel */
    #chatPanel {
        position: fixed;
        bottom: 90px;
        left: 20px;
        width: 350px;
        height: 500px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        z-index: 1000;
    }

    #chatPanelHeader {
        padding: 10px;
        background: #4CAF50;
        color: white;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    #chatPanelBody {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        background: #f9f9f9;
    }

    #chatPanelFooter {
        padding: 10px;
        display: flex;
        gap: 5px;
    }

    #chatPanelFooter input {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    #chatPanelFooter button {
        padding: 6px 12px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .chatMessage {
        margin-bottom: 8px;
        padding: 6px 10px;
        border-radius: 6px;
        max-width: 80%;
    }

    .chatMessage.user {
        background-color: #4CAF50;
        color: white;
        margin-left: auto;
    }

    .chatMessage.bot {
        background-color: #e0e0e0;
        color: black;
        margin-right: auto;
    }
  </style>
</head>
<body>

  <!-- Left Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Dashboard</h2>
      <p class="company">{{ session.get("company") }}</p>
    </div>

    <nav class="sidebar-nav">
      <a href="/dashboard"
         class="nav-item {% if request.path == '/dashboard' %}active{% endif %}">
        Dashboard
      </a>

      <a href="/tasks"
         class="nav-item {% if request.path == '/tasks' %}active{% endif %}">
        Tasks
      </a>

      <a href="/chatbot"
         class="nav-item {% if request.path == '/chatbot' %}active{% endif %}">
        Chatbot
      </a>

      {% if session.get("role") != "user" %}
      <div class="nav-section">
        <span class="nav-section-title">Admin</span>
        <a href="/admin/users/create"
           class="nav-item">
          Create User
        </a>
      </div>
      {% endif %}
    </nav>

    <div class="sidebar-footer">
      <div class="user-info">
        <strong>{{ session.get("name") }}</strong>
        <span>{{ session.get("email") }}</span>
      </div>
      <a href="/logout" class="logout">Logout</a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    {% block content %}{% endblock %}
  </main>

  <!-- Chatbot Button -->
  <button id="chatbotButton">ðŸ’¬</button>

  <!-- Chat Panel -->
  <div id="chatPanel">
      <div id="chatPanelHeader">
          Chatbot
          <button id="closeChat" style="background:none;color:white;border:none;cursor:pointer;font-weight:bold;">Ã—</button>
      </div>
      <div id="chatPanelBody"></div>
      <div id="chatPanelFooter">
          <input type="text" id="chatInput" placeholder="Type your message...">
          <button id="sendChat">Send</button>
      </div>
  </div>

  <script>
    const chatButton = document.getElementById("chatbotButton");
    const chatPanel = document.getElementById("chatPanel");
    const closeChat = document.getElementById("closeChat");
    const chatInput = document.getElementById("chatInput");
    const sendChat = document.getElementById("sendChat");
    const chatBody = document.getElementById("chatPanelBody");

    // Toggle chat panel open/close
    chatButton.addEventListener("click", () => {
        chatPanel.style.display = chatPanel.style.display === "flex" ? "none" : "flex";
    });
    closeChat.addEventListener("click", () => chatPanel.style.display = "none");

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.innerText = text;
        return div.innerHTML;
    }

    function renderMessages(messages) {
        chatBody.innerHTML = "";
        messages.forEach(m => {
            const div = document.createElement("div");
            div.className = "chatMessage " + (m.role === "user" ? "user" : "bot");
            div.innerHTML = m.role === "bot" ? marked.parse(m.content) : escapeHtml(m.content);
            chatBody.appendChild(div);
        });
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    let messages = [];

    async function sendMessage() {
        const msg = chatInput.value.trim();
        if (!msg) return;

        messages.push({ role: "user", content: msg });
        renderMessages(messages);
        chatInput.value = "";

        try {
            const res = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: msg })
            });
            const data = await res.json();
            messages.push({ role: "bot", content: data.response });
            renderMessages(messages);
        } catch (e) {
            messages.push({ role: "bot", content: "Error sending message." });
            renderMessages(messages);
        }
    }

    sendChat.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

    async function loadChatHistory() {
        try {
            const res = await fetch("/api/chat/history");
            const data = await res.json();
            messages = data.history || [];
            renderMessages(messages);
        } catch (e) {
            console.error("Error loading chat history:", e);
        }
    }

    document.addEventListener("DOMContentLoaded", loadChatHistory);
  </script>

</body>
</html>
