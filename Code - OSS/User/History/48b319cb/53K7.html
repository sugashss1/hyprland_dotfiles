{% extends "base.html" %}

{% block title %}Projects{% endblock %}

{% block content %}
<div class="container">
  <h1>Projects</h1>
  <div id="projects-container" class="projects-grid"></div>
</div>

<style>
.projects-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

.project-card {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 15px;
  width: 300px;
  position: relative;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
}

.project-card h3 {
  margin: 0 0 5px;
}

.project-card small {
  display: block;
  color: #555;
}

.project-card button {
  margin-top: 5px;
  padding: 5px 10px;
  font-size: 12px;
  cursor: pointer;
}

.tasks-list {
  margin-top: 10px;
  padding-left: 15px;
}

.task-item {
  font-size: 13px;
  margin-bottom: 3px;
}
</style>

<script>
// Inject current user role
const role = "{{ session.get('role') }}";

async function loadProjects() {
  const res = await fetch("/api/projects");
  const projects = await res.json();

  const container = document.getElementById("projects-container");
  container.innerHTML = "";

  for (const project of projects) {
    const card = document.createElement("div");
    card.className = "project-card";

    // Project info
    card.innerHTML = `
      <h3>${project.project_name}</h3>
      <small><strong>Company:</strong> ${project.company_name || "-"}</small>
      <small><strong>Start:</strong> ${project.start_date ? new Date(project.start_date).toLocaleDateString() : "-"}</small>
      <small><strong>Due:</strong> ${project.due_date ? new Date(project.due_date).toLocaleDateString() : "-"}</small>
      <small><strong>Manager ID:</strong> ${project.manager_id || "-"}</small>
      <div class="tasks-list" id="tasks-${project.id}"><em>Loading tasks...</em></div>
    `;

    // Buttons (Edit/Delete for non-user roles)
    if (role !== "user") {
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.onclick = () => {
        window.location.href = `/projects/edit/${project.id}`;
      };
      card.appendChild(editBtn);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.onclick = async () => {
        if (confirm("Are you sure you want to delete this project?")) {
          await fetch(`/api/projects/${project.id}`, { method: "DELETE" });
          loadProjects();
        }
      };
      card.appendChild(deleteBtn);
    }

    container.appendChild(card);

    // Load tasks for this project
    loadProjectTasks(project.id,project.project_name);
  }
}

async function loadProjectTasks(projectId,projectName) {
  const res = await fetch("/api/tasks");
  const tasks = await res.json();
  const taskContainer = document.getElementById(`tasks-${projectId}`);
  taskContainer.innerHTML = "";

  const projectTasks = tasks.filter(t => t.project_name === projectName || t.project_name === projectName); // match project_name

  if (projectTasks.length === 0) {
    taskContainer.innerHTML = "<em>No tasks assigned</em>";
    return;
  }

  projectTasks.forEach(task => {
    const taskEl = document.createElement("div");
    taskEl.className = "task-item";
    taskEl.innerHTML = `<strong>${task.title}</strong> - ${task.assigned_to || "-"} <em>(${task.status || "TODO"})</em>`;
    taskContainer.appendChild(taskEl);
  });
}

// Initial load
loadProjects();
</script>
{% endblock %}
