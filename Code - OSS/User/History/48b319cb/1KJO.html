{% extends "base.html" %}

{% block title %}Projects{% endblock %}

{% block content %}
<div class="container">
  <h1>Projects</h1>
  <div id="projects-container" class="projects-grid"></div>
</div>

<!-- Edit Project Modal -->
<div id="editProjectModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px; margin:auto; padding:20px; border:1px solid #ccc; border-radius:8px; background:#fff; position:relative;">
    <span id="closeModal" style="position:absolute; top:10px; right:15px; cursor:pointer;">&times;</span>
    <h3>Edit Project</h3>
    <form id="editProjectForm">
      <input type="hidden" id="editProjectId">
      <label>Project Name:</label><br>
      <input type="text" id="editProjectName" required style="width:100%; margin-bottom:10px;"><br>
      <label>Description:</label><br>
      <textarea id="editProjectDescription" style="width:100%; margin-bottom:10px;"></textarea><br>
      <label>Start Date:</label><br>
      <input type="date" id="editStartDate" style="width:100%; margin-bottom:10px;"><br>
      <label>Due Date:</label><br>
      <input type="date" id="editDueDate" style="width:100%; margin-bottom:10px;"><br>
      <button type="submit">Save Changes</button>
    </form>
  </div>
</div>

<style>

.modal {
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
}

.projects-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

.project-card {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 15px;
  width: 300px;
  position: relative;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
}

.project-card h3 {
  margin: 0 0 5px;
}

.project-card small {
  display: block;
  color: #555;
}

.project-card button {
  margin-top: 5px;
  padding: 5px 10px;
  font-size: 12px;
  cursor: pointer;
}

.tasks-list {
  margin-top: 10px;
  padding-left: 15px;
}

.task-item {
  font-size: 13px;
  margin-bottom: 3px;
}

.project-tooltip {
  position: relative;
  display: inline-block;
}

.project-tooltip {
  visibility: hidden;
  width: 250px;
  background-color: #333;
  color: #fff;
  text-align: left;
  padding: 8px 10px;
  border-radius: 5px;
  position: absolute;
  z-index: 10;
  bottom: 110%; /* above the card */
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.3s;
}

.project-tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}


</style>

<script>
// Inject current user role
const role = "{{ session.get('role') }}";

async function loadProjects() {
  const res = await fetch("/api/projects");
  const projects = await res.json();

  const container = document.getElementById("projects-container");
  container.innerHTML = "";

  for (const project of projects) {
    const card = document.createElement("div");
    card.className = "project-card";

    // Project info
    card.innerHTML = `
  <div class="project-card">
    <h3>${project.project_name}</h3>
    <small><strong>Company:</strong> ${project.company_name || "-"}</small>
    <small><strong>Start:</strong> ${project.start_date ? new Date(project.start_date).toLocaleDateString() : "-"}</small>
    <small><strong>Due:</strong> ${project.due_date ? new Date(project.due_date).toLocaleDateString() : "-"}</small>
    <small><strong>Manager ID:</strong> ${project.manager_id || "-"}</small>
    <div class="tasks-list" id="tasks-${project.id}"><em>Loading tasks...</em></div>
  </div>
  <span class="project">${project.description || "No description"}</span>
`;

    // Buttons (Edit/Delete for non-user roles)
    if (role !== "user") {
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.onclick = () => openEditModal(project);
      card.appendChild(editBtn);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.onclick = async () => {
        if (confirm("Are you sure you want to delete this project?")) {
          await fetch(`/api/projects/${project.id}`, { method: "DELETE" });
          loadProjects();
        }
      };
      card.appendChild(deleteBtn);
    }

    container.appendChild(card);

    // Load tasks for this project
    loadProjectTasks(project.id,project.project_name);
  }
}

async function loadProjectTasks(projectId,projectName) {
  const res = await fetch("/api/tasks");
  const tasks = await res.json();
  const taskContainer = document.getElementById(`tasks-${projectId}`);
  taskContainer.innerHTML = "";

  const projectTasks = tasks.filter(t => t.project_name === projectName || t.project_name === projectName); // match project_name

  if (projectTasks.length === 0) {
    taskContainer.innerHTML = "<em>No tasks assigned</em>";
    return;
  }

  projectTasks.forEach(task => {
    const taskEl = document.createElement("div");
    taskEl.className = "task-item";
    taskEl.innerHTML = `<strong>${task.title}</strong> - ${task.assigned_to || "-"} <em>(${task.status || "TODO"})</em>`;
    taskContainer.appendChild(taskEl);
  });
}

// Initial load
loadProjects();

// Open edit modal
function openEditModal(project) {
  document.getElementById("editProjectId").value = project.id;
  document.getElementById("editProjectName").value = project.project_name || "";
  document.getElementById("editProjectDescription").value = project.description || "";
  document.getElementById("editStartDate").value = project.start_date ? project.start_date.split("T")[0] : "";
  document.getElementById("editDueDate").value = project.due_date ? project.due_date.split("T")[0] : "";

  document.getElementById("editProjectModal").style.display = "block";
}

// Close modal
document.getElementById("closeModal").onclick = () => {
  document.getElementById("editProjectModal").style.display = "none";
}

// Handle form submit
document.getElementById("editProjectForm").onsubmit = async (e) => {
  e.preventDefault();

  const projectId = document.getElementById("editProjectId").value;
  const data = {
    project_name: document.getElementById("editProjectName").value,
    description: document.getElementById("editProjectDescription").value,
    start_date: document.getElementById("editStartDate").value,
    due_date: document.getElementById("editDueDate").value
  };

  const res = await fetch(`/api/projects/${projectId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  if (res.ok) {
    alert("Project updated successfully!");
    document.getElementById("editProjectModal").style.display = "none";
    loadProjects(); // Refresh project list
  } else {
    alert("Failed to update project.");
  }
};

</script>
{% endblock %}
